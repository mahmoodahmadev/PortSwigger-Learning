# LAB: Exploiting XSS to bypass CSRF defenses

## Objective:

Explore the forms on the website to find csrf token to exploit using XSS to
update emails of other users to your choice

## Key Concepts:

- CSRF tokens
- Generate custom form data
- bypass CSRF tokens using XSS

## Steps Taken:

1. Login with given credentials
2. Create an email update request to find the endpoint to update email of users.
3. Find forms in the application.
4. View Page source to find any hidden input field or fields with csrf token
   attributes.
5. Find a way to get the value of csrf attribute using document object.
6. Prepare a script to create custom form data and then make an update email
   request with victim's csrf token.

## Payloads Used:

```javascript
document.addEventListener("DOMContentLoaded", () => {
  let csrf = document.getElementsByName("csrf")[0].value;

  let form = new FormData();

  form.append("csrf", csrf);
  form.append("email", "gunpark@gmail.com");

  fetch(
    "https://0a5c005604a15db38025171d00070071.web-security-academy.net/my-account/change-email",
    {
      method: "POST",
      mode: "no-cors",
      body: form,
    }
  );
});
```

## Issues Encountered:

- Faced issue to fetch value of csrf token using dom manipulation.
- Didn't knew I had to create a formData object to replicate real form.
- Payload was not working when I directly made the API call.

## Solutions/Workarounds:

- Inspected the target application, focused on each step at a time to expand the
  result of each step and then finally found the csrf attribute value.
- Saw a follow-up video and came to know about that we can create form data
  using the formData class object.
- Because, my script was dependent on first fetching the value from DOM, I had
  to wait till the DOM is loaded fully, so for that I had to use
  DOMContentLoaded eventlistener.

## Takeaways:

- CSRF tokens are just random strings provided in response from server to
  protect unwillingly made XSS driven actions.
- When the script is dependent on the DOM manipulation, make sure to wait until
  DOM is fully loaded
